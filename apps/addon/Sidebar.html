<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Analyst (Phase 1.1)</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; }
      header { padding: 12px 14px; border-bottom: 1px solid #eee; font-weight: 600; }
      .wrap { padding: 12px 14px; }
      .row { display: flex; gap: 8px; align-items: center; margin-bottom: 12px; flex-wrap: wrap; }
      button { padding: 8px 10px; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; background: #fff; }
      button.primary { border-color: #2a7; }
      pre { background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 10px; max-height: 420px; overflow: auto; }
      small { color: #666; }
      input[type="text"] { width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px;}
      .hint { font-size: 12px; color: #666; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    </style>
  </head>
  <body>
    <header>AI Analyst — Phase 2.0</header>
    <div class="wrap">
      <div class="row">
        <button class="primary" id="btnRead">Read context</button>
        <button id="btnPreview">Preview change</button>
        <button id="btnLocalHello">Write “hello” locally</button>
        <button id="btnBackendHello" disabled>Apply via backend</button>
        <button id="btnClear">Clear</button>
      </div>

      <div class="row">
        <button id="btnConnect">Connect Google (OAuth)</button>
        <small>Redirect URI must be <code class="mono">/functions/v1/oauth-callback</code></small>
      </div>

      <div class="row">
        <label class="hint">Functions base URL:</label>
        <input id="baseUrl" type="text" value="https://zyqjprqctwiejxoeficw.functions.supabase.co" />
      </div>
      <div class="row">
        <label class="hint">Supabase anon key (optional for local tests):</label>
        <input id="anonKey" type="text" value="" />
      </div>

      <div class="row">
        <button id="btnPing">Ping backend (/plan)</button>
        <small class="hint">Optional sanity check.</small>
      </div>

      <pre id="out">1) Connect Google → finish OAuth in new tab.\n2) Read context.\n3) Preview change → confirm summary.\n4) Apply via backend.\n\nBase must point to your functions (dev default shown).</pre>
    </div>

    <script>
      (function () {
        const out = document.getElementById('out');
        const btnRead = document.getElementById('btnRead');
        const btnClear = document.getElementById('btnClear');
        const btnPreview = document.getElementById('btnPreview');
        const btnLocalHello = document.getElementById('btnLocalHello');
        const btnBackendHello = document.getElementById('btnBackendHello');
        const btnConnect = document.getElementById('btnConnect');
        const btnPing = document.getElementById('btnPing');
        const baseUrl = document.getElementById('baseUrl');
        const anonKey = document.getElementById('anonKey');

        // Stable client user id (stored locally; binds OAuth tokens server-side)
        const storageKey = 'ai_analyst_client_user_id';
        let clientUserId = localStorage.getItem(storageKey);
        if (!clientUserId) {
          clientUserId = 'u_' + Math.random().toString(36).slice(2) + Date.now();
          localStorage.setItem(storageKey, clientUserId);
        }

        function print(obj) { out.textContent = JSON.stringify(obj, null, 2); }
        function err(e) {
          if (e instanceof Error) {
            print({ error: e.message, stack: e.stack });
          } else {
            print({ error: String(e && e.message || e) });
          }
        }
        function headers() {
          return {
            'Content-Type': 'application/json',
            ...(anonKey.value ? { 'Authorization': 'Bearer ' + anonKey.value, 'apikey': anonKey.value } : {})
          };
        }
        function fn(path) {
          return baseUrl.value.replace(/\/$/, '') + path;
        }

        let lastPreview = null;
        let lastContextSignature = null;

        function contextSignature(ctx) {
          return `${ctx.spreadsheetId}:${ctx.sheetId}:${ctx.activeRangeA1}`;
        }

        function resetPreviewState() {
          lastPreview = null;
          lastContextSignature = null;
          btnBackendHello.disabled = true;
        }

        // Read current sheet context via Apps Script
        btnRead.addEventListener('click', function () {
          out.textContent = 'Reading…';
          google.script.run
            .withSuccessHandler(function (ctx) {
              print({ clientUserId, ctx });
              window.__ctx = ctx;
              resetPreviewState();
            })
            .withFailureHandler(err)
            .getContext();
        });

        // Start OAuth: calls /oauth-start to get authUrl, opens in a tab
        btnConnect.addEventListener('click', async function () {
          try {
            out.textContent = 'Starting OAuth…';
            const res = await fetch(fn('/oauth-start'), {
              method: 'POST', headers: headers(), body: JSON.stringify({ clientUserId })
            });
            const json = await res.json();
            if (!json.authUrl) return err('No authUrl from server');
            window.open(json.authUrl, '_blank', 'width=520,height=640');
            print({ step: 'oauth_started', clientUserId, redirect: '.../oauth-callback' });
          } catch (e) { err(e); }
        });

        // Request preview via Supabase
        async function ensureContext() {
          if (window.__ctx) return window.__ctx;
          return await new Promise((resolve, reject) => {
            google.script.run
              .withSuccessHandler((ctx) => {
                window.__ctx = ctx;
                resolve(ctx);
              })
              .withFailureHandler(reject)
              .getContext();
          });
        }

        btnPreview.addEventListener('click', async function () {
          try {
            out.textContent = 'Previewing…';
            const ctx = await ensureContext();
            const res = await fetch(fn('/preview'), {
              method: 'POST',
              headers: headers(),
              body: JSON.stringify({ clientUserId, context: ctx })
            });
            const json = await res.json();
            if (!res.ok || !json.ok) {
              err(json?.error || `Preview failed (${res.status})`);
              resetPreviewState();
              return;
            }
            lastPreview = json.preview;
            lastContextSignature = contextSignature(ctx);
            btnBackendHello.disabled = false;
            print({ preview: json.preview, ctx });
          } catch (e) {
            err(e);
            resetPreviewState();
          }
        });

        // Apply via Apps Script locally
        btnLocalHello.addEventListener('click', function () {
          out.textContent = 'Applying locally…';
          google.script.run
            .withSuccessHandler(function (result) {
              print({ mode: 'local', result });
              resetPreviewState();
            })
            .withFailureHandler(err)
            .applyLocalWriteHello();
        });

        // Apply via backend: posts clientUserId + context to /apply
        btnBackendHello.addEventListener('click', async function () {
          try {
            out.textContent = 'Applying via backend…';
            const ctx = await ensureContext();
            if (!lastPreview || lastContextSignature !== contextSignature(ctx)) {
              err("Run preview before applying.");
              btnBackendHello.disabled = true;
              return;
            }
            const res = await fetch(fn('/apply'), {
              method: 'POST', headers: headers(),
              body: JSON.stringify({ clientUserId, context: ctx })
            });
            const json = await res.json();
            print(json);
            resetPreviewState();
          } catch (e) { err(e); }
        });

        // Optional: ping /plan
        btnPing.addEventListener('click', async function () {
          try {
            out.textContent = 'Pinging…';
            const res = await fetch(fn('/plan'), {
              method: 'POST', headers: headers(),
              body: JSON.stringify({ instruction: 'ping', from: 'sidebar' })
            });
            const text = await res.text();
            if (!res.ok) {
              print({ status: res.status, statusText: res.statusText, body: text });
              return;
            }
            let json;
            try {
              json = JSON.parse(text);
            } catch (parseErr) {
              print({ status: res.status, raw: text, parseError: String(parseErr) });
              return;
            }
            print(json);
          } catch (e) { err(e); }
        });
        btnClear.addEventListener('click', function () { out.textContent = ''; resetPreviewState(); });
      })();
    </script>
  </body>
</html>
