<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Agent Workspace</title>
    <style>
      :root { color-scheme: light dark; }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
        background: #f5f7fb;
        display: flex;
        flex-direction: column;
        color: #1f2937;
      }
      .toolbar {
        display: grid;
        grid-template-columns: 3fr 1fr;
        align-items: center;
        padding: 8px 18px;
        min-height: 30px;
        background: #ffffff;
        border-bottom: 1px solid #e2e8f0;
        box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
        position: sticky;
        top: 0;
        z-index: 5;
      }
      .toolbar-title {
        font-size: 14px;
        font-weight: 600;
        color: #1f2937;
      }
      .toolbar-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
      }
      .toolbar-actions .icon {
        border: none;
        background: transparent;
        color: #1f2937;
        cursor: pointer;
        font-size: 16px;
      }
      .toolbar-actions .icon:hover {
        color: #2563eb;
      }
      .workspace {
        flex: 1;
        padding: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }
      .todo-panel {
        display: none;
        background: #ffffff;
        border-bottom: 1px solid #e2e8f0;
        padding: 12px 16px;
      }
      .todo-header {
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: #2563eb;
      }
      .todo-list {
        list-style: none;
        margin: 10px 0 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .todo-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #475569;
      }
      .todo-indicator {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: 2px solid #bfdbfe;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #2563eb;
        background: rgba(59, 130, 246, 0.12);
      }
      .todo-item.in_progress .todo-indicator {
        background: #2563eb;
        border-color: #2563eb;
        color: #ffffff;
      }
      .todo-item.done .todo-indicator {
        background: #4ade80;
        border-color: #4ade80;
        color: #ffffff;
      }
      .todo-item.blocked .todo-indicator {
        background: #f87171;
        border-color: #f87171;
        color: #ffffff;
      }
      .todo-title {
        flex: 1;
      }
      .chat-panel {
        flex: 1;
        border-radius: 0;
        border: none;
        background: #ffffff;
        box-shadow: none;
        padding: 12px 16px;
        overflow-y: auto;
        font-size: 13px;
        line-height: 1.45;
        color: #475569;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .bubble {
        max-width: 80%;
        padding: 10px 12px;
        border-radius: 16px;
        font-size: inherit;
        line-height: inherit;
        white-space: pre-wrap;
      }
      .bubble.user {
        align-self: flex-end;
        background: rgba(148, 163, 184, 0.16);
        color: #1f2937;
      }
      .bubble.agent {
        align-self: flex-start;
        background: transparent;
        color: #475569;
      }
      .composer {
        padding: 0px 12px 12px;
        background: #f5f7fb;
        display: flex;
        flex-direction: column;
        gap: 12px;
        position: sticky;
        bottom: 0;
        z-index: 5;
      }
      .attachment-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        min-height: 10px;
        padding-left: 4px;
      }
      .composer-shell {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .composer-input {
        border-radius: 12px;
        background: #ffffff;
        border: 1px solid #dbeafe;
        box-shadow: inset 0 0 0 1px rgba(59, 130, 246, 0.08);
        padding: 8px 8px;
        display: flex;
        min-height: 56px;
      }
      .composer-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .composer-controls .center {
        flex: 1;
        display: flex;
        justify-content: center;
      }
      .attachment-pill {
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(59, 130, 246, 0.18);
        color: #1d4ed8;
        font-size: 12px;
      }
      .composer-btn {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: none;
        background: #ffffff;
        box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        cursor: pointer;
        color: #1f2937;
        transition: transform 0.15s ease;
      }
      .composer-btn:hover { transform: translateY(-1px); }
      .composer-btn.attach {
        border: 1px dashed #93c5fd;
        background: rgba(59, 130, 246, 0.18);
        color: #2563eb;
      }
      .composer-btn.send {
        background: #2563eb;
        color: #ffffff;
      }
      .composer-btn.stop {
        background: #fee2e2;
        color: #b91c1c;
      }
      .composer-btn input { display: none; }
      textarea {
        flex: 1;
        resize: none;
        border: none;
        background: transparent;
        font-family: inherit;
        font-size: 13px;
        color: #1f2937;
        min-height: 32px;
      }
      textarea:focus { outline: none; }
      .footer {
        padding: 8px 24px 18px;
        text-align: right;
        font-size: 12px;
        color: #6b7280;
      }
    </style>
  </head>
  <body>
    <nav class="toolbar">
      <div class="toolbar-title" id="toolbarTitle">Session — Untitled</div>
      <div class="toolbar-actions">
        <button class="icon" title="History">⟳</button>
        <button class="icon" title="Settings">⚙</button>
        <button class="icon" title="New chat">＋</button>
      </div>
    </nav>
    <main class="workspace">
      <section class="todo-panel" id="todoPanel">
        <header class="todo-header">Todo Tracker</header>
        <ul class="todo-list" id="todoList"></ul>
      </section>
      <section class="chat-panel" id="chatPanel"></section>
      <div class="composer">
        <div class="attachment-row" id="attachmentRow"></div>
        <div class="composer-shell">
          <div class="composer-input">
            <textarea id="messageInput" placeholder="Ask anything about your spreadsheet..."></textarea>
          </div>
          <div class="composer-controls">
            <label class="composer-btn attach" title="Attach">
              ＋
              <input type="file" id="fileInput" multiple accept="image/*,application/pdf" />
            </label>
            <div class="center">
              <button class="composer-btn" id="rulesBtn" title="Rules">⚙</button>
            </div>
            <button class="composer-btn send" id="sendBtn" title="Send">↑</button>
          </div>
        </div>
      </div>
    </main>
    <script>
      (function () {
        const fileInput = document.getElementById('fileInput');
        const attachmentRow = document.getElementById('attachmentRow');
        const sendBtn = document.getElementById('sendBtn');
        const messageInput = document.getElementById('messageInput');
        const chatPanel = document.getElementById('chatPanel');
        const toolbarTitle = document.getElementById('toolbarTitle');
        const todoPanel = document.getElementById('todoPanel');
        const todoList = document.getElementById('todoList');

        const CONFIG = {
          functionsUrl: 'https://zyqjprqctwiejxoeficw.functions.supabase.co',
          anonKey:
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5cWpwcnFjdHdpZWp4b2VmaWN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NjM1NDAsImV4cCI6MjA3NjEzOTU0MH0.FJObUb_tf_dvEM5Nu0FXv52acfbosYy3SsF2AWznLo0'
        };

        let runActive = false;
        const sessionKey = 'ai-analyst-session-id';
        let cachedSessionId = null;
        let currentSpreadsheetId = null;
        let historyLoaded = false;
        let currentRunId = null;

        function appendMessage(text, role) {
          const block = document.createElement('div');
          block.className = role === 'user' ? 'bubble user' : 'bubble agent';
          block.textContent = text;
          chatPanel.appendChild(block);
          chatPanel.scrollTop = chatPanel.scrollHeight;
        }

        function appendHistoryMessage({ content, role, metadata }) {
          if (role !== 'user' && metadata && typeof metadata.summary === 'string') {
            appendAgentEvent(content, metadata.summary);
            return;
          }
          appendMessage(content, role === 'user' ? 'user' : 'agent');
        }

        function appendAgentEvent(title, details) {
          const block = document.createElement('div');
          block.className = 'bubble agent';
          const strong = document.createElement('strong');
          strong.textContent = `${title}\n`;
          const para = document.createElement('div');
          para.style.whiteSpace = 'pre-wrap';
          para.style.fontSize = '12px';
          para.style.opacity = '0.85';
          para.textContent = details;

          block.appendChild(strong);
          block.appendChild(para);
          chatPanel.appendChild(block);
          chatPanel.scrollTop = chatPanel.scrollHeight;
        }

        fileInput.addEventListener('change', () => {
          attachmentRow.innerHTML = '';
          Array.from(fileInput.files || []).forEach((file) => {
            const pill = document.createElement('span');
            pill.className = 'attachment-pill';
            pill.textContent = file.name;
            attachmentRow.appendChild(pill);
          });
        });

        function setRunState(active) {
          runActive = active;
          if (active) {
            sendBtn.classList.add('stop');
            sendBtn.classList.remove('send');
            sendBtn.textContent = '■';
          } else {
            sendBtn.classList.remove('stop');
            sendBtn.classList.add('send');
            sendBtn.textContent = '↑';
          }
        }

        function randomId(prefix) {
          if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
          return `${prefix || 'id'}-${Math.random().toString(16).slice(2)}-${Date.now()}`;
        }

        function authHeaders() {
          return {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${CONFIG.anonKey}`,
            apikey: CONFIG.anonKey
          };
        }

        function getSessionId() {
          if (cachedSessionId) return cachedSessionId;
          try {
            const stored = window.localStorage.getItem(sessionKey);
            if (stored) {
              cachedSessionId = stored;
              return cachedSessionId;
            }
          } catch (_) {
            // localStorage might be unavailable; ignore.
          }
          cachedSessionId = randomId('session');
          try {
            window.localStorage.setItem(sessionKey, cachedSessionId);
          } catch (_) {
            // ignore storage failures
          }
          return cachedSessionId;
        }

        function getSpreadsheetTitle() {
          return new Promise((resolve) => {
            if (!google || !google.script || !google.script.run) {
              resolve(null);
              return;
            }
            google.script.run
              .withSuccessHandler((title) => resolve(title))
              .withFailureHandler(() => resolve(null))
              .getActiveSpreadsheetName?.();
          });
        }

        function fetchSheetContext() {
          return new Promise((resolve, reject) => {
            if (!google || !google.script || !google.script.run) {
              reject(new Error('Apps Script runtime unavailable.'));
              return;
            }
            google.script.run
              .withSuccessHandler((context) => resolve(context))
              .withFailureHandler((err) => reject(err))
              .getContext();
          });
        }

        async function postToFunctions(path, body) {
          const res = await fetch(`${CONFIG.functionsUrl.replace(/\/$/, '')}${path}`, {
            method: 'POST',
            headers: authHeaders(),
            body: JSON.stringify(body)
          });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(`HTTP ${res.status}: ${text}`);
          }
          return res.json();
        }

        async function logMessage({ role, content, metadata }) {
          if (!currentSpreadsheetId) return;
          try {
            await fetch(`${CONFIG.functionsUrl.replace(/\/$/, '')}/agent_messages`, {
              method: 'POST',
              headers: authHeaders(),
              body: JSON.stringify({
                sessionId: getSessionId(),
                spreadsheetId: currentSpreadsheetId,
                role,
                content,
                metadata
              })
            });
          } catch (error) {
            console.warn('Failed to log message', error);
          }
        }

        async function loadHistory() {
          if (historyLoaded || !currentSpreadsheetId) return;
          try {
            const params = new URLSearchParams({
              sessionId: getSessionId(),
              spreadsheetId: currentSpreadsheetId,
              limit: '100'
            });
            const res = await fetch(
              `${CONFIG.functionsUrl.replace(/\/$/, '')}/agent_messages?${params.toString()}`,
              { headers: authHeaders() }
            );
            if (!res.ok) {
              console.warn('Failed to load history', await res.text());
              return;
            }
            const json = await res.json();
            if (!json?.ok) return;
            chatPanel.innerHTML = '';
            (json.messages ?? []).forEach((msg) => appendHistoryMessage(msg));
            historyLoaded = true;
          } catch (error) {
            console.warn('Failed to load history', error);
          }
        }

        function renderTodos(todos) {
          if (!Array.isArray(todos) || todos.length === 0) {
            todoPanel.style.display = 'none';
            todoList.innerHTML = '';
            return;
          }
          todoPanel.style.display = 'block';
          todoList.innerHTML = '';
          todos.forEach((todo, index) => {
            const item = document.createElement('li');
            item.className = `todo-item ${todo.status || ''}`.trim();

            const indicator = document.createElement('span');
            indicator.className = 'todo-indicator';
            indicator.textContent = todo.status === 'done' ? '✓' : String(index + 1);

            const title = document.createElement('span');
            title.className = 'todo-title';
            title.textContent = todo.title ?? 'Untitled task';

            item.appendChild(indicator);
            item.appendChild(title);
            todoList.appendChild(item);
          });
        }

        async function runPlanner(instruction) {
          if (!currentSpreadsheetId || !currentRunId) return;
          try {
            const response = await postToFunctions('/planner', {
              sessionId: getSessionId(),
              spreadsheetId: currentSpreadsheetId,
              runId: currentRunId,
              instruction
            });
            if (response?.cancelled) {
              appendAgentEvent('Planner stopped', 'Run cancelled before planning step.');
              await logMessage({ role: 'event', content: 'Planner run cancelled.' });
              return;
            }
            if (!response?.ok) {
              appendAgentEvent('Planner error', 'Planner returned an unexpected response.');
              await logMessage({ role: 'event', content: 'Planner returned an unexpected response.' });
              return;
            }

            renderTodos(response.todos || []);

            if (response.todo?.title) {
              appendAgentEvent('Planner started', response.todo.title);
              await logMessage({
                role: 'agent',
                content: 'Planner started',
                metadata: { todoId: response.todo.id, title: response.todo.title }
              });
            }
          } catch (error) {
            const message = error instanceof Error ? error.message : String(error);
            appendAgentEvent('Planner error', message);
            await logMessage({ role: 'event', content: `Planner error: ${message}` });
          }
        }

        async function boot() {
          try {
            const [context, title] = await Promise.all([fetchSheetContext(), getSpreadsheetTitle()]);
            if (context?.spreadsheetId) {
              currentSpreadsheetId = context.spreadsheetId;
              await loadHistory();
            }
            if (title) {
              toolbarTitle.textContent = `Session — ${title}`;
            }
          } catch (error) {
            console.warn('Initial load failed', error);
          }
        }

        boot();

        async function submitMessage() {
          if (runActive) {
            setRunState(false);
            return;
          }
          if (!messageInput.value.trim() && !(fileInput.files && fileInput.files.length)) return;
          setRunState(true);
          const text = messageInput.value.trim();
          if (text) {
            appendMessage(text, 'user');
          }
          messageInput.value = '';
          try {
            const [context, title] = await Promise.all([fetchSheetContext(), getSpreadsheetTitle()]);
            if (title) {
              toolbarTitle.textContent = `Session — ${title}`;
            }

            const sessionId = getSessionId();
            const runId = randomId('run');
            currentRunId = runId;
            appendMessage('Capturing sheet context…', 'agent');

             if (context?.spreadsheetId) {
               currentSpreadsheetId = context.spreadsheetId;
               await loadHistory();
             }
            if (text) {
              await logMessage({ role: 'user', content: text });
            }

            const payload = {
              sessionId,
              spreadsheetId: context?.spreadsheetId ?? 'unknown-sheet',
              runId,
              sheetContext: context
            };

            const planResponse = await postToFunctions('/plan', payload);
            if (planResponse?.cancelled) {
              appendMessage('Run cancelled before planning.', 'agent');
              await logMessage({ role: 'event', content: 'Run cancelled before planning.' });
            } else {
              const summaryLines = [
                `Sheet: ${context.sheetName}`,
                `Selection: ${context.activeRangeA1}`,
                `Size: ${context.activeRowCount} × ${context.activeColumnCount}`,
                `Captured at: ${new Date(planResponse.timestamp ?? Date.now()).toLocaleTimeString()}`
              ].join('\n');
              appendAgentEvent('Context captured', summaryLines);
              await logMessage({
                role: 'agent',
                content: 'Context captured',
                metadata: { summary: summaryLines }
              });
              await runPlanner(text);
            }
          } catch (error) {
            const message = error instanceof Error ? error.message : String(error);
            appendAgentEvent('Context capture failed', message);
            await logMessage({ role: 'event', content: `Context capture failed: ${message}` });
          } finally {
            setRunState(false);
          }
        }

        sendBtn.addEventListener('click', submitMessage);
        messageInput.addEventListener('keydown', (event) => {
          if (event.key === 'Enter' && (event.metaKey || !event.shiftKey)) {
            event.preventDefault();
            submitMessage();
          }
        });
      })();
    </script>
  </body>
</html>
